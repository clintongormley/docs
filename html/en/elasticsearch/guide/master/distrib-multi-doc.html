
<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Multidocument Patterns</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide" /><link rel="up" href="distributed-docs.html" title="Distributed Document Store" /><link rel="prev" href="_partial_updates_to_a_document.html" title="Partial Updates to a Document" /><link rel="next" href="search.html" title="Searching—The Basic Tools" />
  
 
 	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
 	
	<meta name="description" content="" />
	<meta name="keywords" content="" />



	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<!-- For third-generation iPad with high-resolution Retina display: -->
	<link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">

	<!-- For iPhone with high-resolution Retina display: -->

	<link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">

	<!-- For first- and second-generation iPad: -->

	<link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
	<!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'> -->
	<link type="text/css" rel="stylesheet" href="/static/css/skel.css" />	
	<link type="text/css" rel="stylesheet" href="/static/css/style.css" />	
	<script src="/static/js/skel.min.js"></script>
	<script type="text/javascript">form_name = "guide_template"</script>
	<script src="/static/js/init.js"></script>
	<script src="/static/js/classie.js"></script>
	<!--<script type="text/javascript">
	    (function() {
	        var path = '//easy.myfonts.net/v2/js?sid=10336(font-family=Avenir+35+Light)&sid=10338(font-family=Avenir+55+Roman)&sid=10340(font-family=Avenir+85+Heavy)&sid=10344(font-family=Avenir+65+Medium)&key=nAD6PCOPrX',
	            protocol = ('https:' == document.location.protocol ? 'https:' : 'http:'),
	            trial = document.createElement('script');
	        trial.type = 'text/javascript';
	        trial.async = true;
	        trial.src = protocol + path;
	        var head = document.getElementsByTagName("head")[0];
	        head.appendChild(trial);
	    })();
	</script>-->

	
	<link type="text/css" rel="stylesheet" href="/static/css/prettify.css" />
	<link rel="stylesheet" type="text/css" href="/static/css/guide_template.css" />	
	<script type="text/javascript" src="/static/js/prettify.js"></script>

	

<link rel="stylesheet" type="text/css" href="styles.css" />

</head>
<body >
	<!-- Google Tag Manager -->
	<script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5"
													  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
			'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-58RLH5');</script>
	<!-- End Google Tag Manager -->
	
	<div class="header-cont">
		<div id="header-wrapper">
			

<div class="container w100">
	<div class="row">
		<div class="12u">
			<section>
				<div class="row">
					<div class="8u 6u(small) 6u(xsmall)">
						<div id="elastic">
							<h1><a href="/"></a></h1>
						</div>
						<!-- Searchbar Input box -->
						<form method="get" action="/search" name="searchForm" class="header-search-form">
						   <input type="text" id="search-header-autocomplete" name="q" class="form-control global-input" placeholder="elastic{search}">
						</form>
						<div class="mobile-auto-complete"></div> 
					</div>
					<div class="4u 6u(small) 6u(xsmall)">
						<!-- Mobile Menu -->
						<div class="mobile-menu-wrapper">
							<ul class="m-shortcuts">
								<li><a id="header-search" class="m-search" href="#"></a></li>
								<li><a class="m-guide" href="/guide"></a></li>
								<li><a class="m-contact" href="/contact"></a></li>
							</ul>											
							<nav class="nav-menu">
								<div class="menu-button">
									<span></span>
								</div>
								<div class="nav-menu-list-wrap">
									<div class="nav-menu-list">
										<h3><a href="/products">Products</a></h3>
										<ul>
											<li><a href="/products/elasticsearch">Elasticsearch</a></li>
											<li><a href="/products/logstash">Logstash</a></li>
											<li><a href="/products/kibana">Kibana</a></li>
											<li><a href="/products/shield">Shield</a></li>
											<li><a href="/products/marvel">Marvel</a></li>
											<li><a href="/products/hadoop">Hadoop</a></li>
											<li><a href="/subscriptions">Support</a></li>
											<li><a href="/downloads">Downloads</a></li>
										</ul>
										<h3><a href="/subscriptions">Subscriptions</a></h3>
										<h3><a href="/learn">Learn</a></h3>
										<ul>
											<li><a href="/guide">Docs</a></li>
											<li><a href="/videos">Videos</a></li>
											<li><a href="https://purchases.elastic.co" target="_blank">Training</a></li>
											<li><a href="/blog">Blog</a></li>
											<li><a href="/elasticon">elastic{ON}</a></li>
										</ul>
										<h3><a href="/community">Community</a></h3>
										<ul>
											<li><a href="/community/meetups">Meetups</a></li>
										</ul>
										<h3><a href="/use-cases">Use Cases</a></h3>
										<h3><a href="/about">About</a></h3>
										<ul>
											<li><a href="/about/leadership">Leadership</a></li>
											<li><a href="/about/board">Board of Directors</a></li>
											<li><a href="/about/careers">Careers</a></li>
											<li><a href="/about/partners">Partners</a></li>
											<li><a href="/about/press">Press</a></li>
										</ul>
									</div>
								</div>
							</nav>
						</div>
						<!-- Shortcuts -->
						<nav id="shortcuts">
							<ul class="links">
								
									<li class="sc-downloads grayscale"><a href="/downloads" id="header_downloads">downloads</a></li>
								
									<li class="sc-docs grayscale"><a href="/guide" id="header_guide">docs</a></li>
								
									<li class="sc-support grayscale"><a href="/subscriptions" id="header_subscriptions">support</a></li>
								
									<li class="sc-contact grayscale"><a href="/contact" id="header_contact">contact</a></li>
								
							</ul>
						</nav>
					</div>
				</div>
			</section>
			

<section class="desktop-main-nav">
	<div class="row">
		<div class="9u">
			<!-- Nav -->
			<nav id="nav">
				<ul>
					
					<li>
						<a href="/products" id="nav_products" >PRODUCTS</a>
						
						<ul class="dropdown">
							
								<li><a href="/products/elasticsearch" id="nav_elasticsearch" >elasticsearch</a></li>								
							
								<li><a href="/products/logstash" id="nav_logstash" >logstash</a></li>								
							
								<li><a href="/products/kibana" id="nav_kibana" >kibana</a></li>								
							
								<li><a href="/products/shield" id="nav_shield" >shield</a></li>								
							
								<li><a href="/products/marvel" id="nav_marvel" >marvel</a></li>								
							
								<li><a href="/products/hadoop" id="nav_hadoop" >hadoop</a></li>								
							
								<li><a href="/subscriptions" id="nav_support" >support</a></li>								
							
								<li><a href="/downloads" id="nav_downloads" >downloads</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/subscriptions" id="nav_subscriptions" >SUBSCRIPTIONS</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/learn" id="nav_learn" >LEARN</a>
						
						<ul class="dropdown">
							
								<li><a href="/guide" id="nav_guide" >docs</a></li>								
							
								<li><a href="/videos" id="nav_videos" >videos</a></li>								
							
								<li><a href="http://purchases.elastic.co" id="nav_training" >training</a></li>								
							
								<li><a href="/blog" id="nav_learn_blog" >blog</a></li>								
							
								<li><a href="/elasticon" id="nav_learn_elasticon" >elastic{ON}</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/community" id="nav_community" >COMMUNITY</a>
						
						<ul class="dropdown">
							
								<li><a href="/community/meetups" id="nav_meetups" >meetups</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/use-cases" id="nav_usecases" >USE CASES</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/blog" id="nav_blog" >BLOG</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/about" id="nav_about" >ABOUT</a>
						
						<ul class="dropdown">
							
								<li><a href="/about/leadership" id="nav_leadership" >leadership</a></li>								
							
								<li><a href="/about/board" id="nav_board" >board of directors</a></li>								
							
								<li><a href="/about/careers" id="nav_careers" >careers</a></li>								
							
								<li><a href="/about/partners" id="nav_partners" >partners</a></li>								
							
								<li><a href="/about/press" id="nav_press" >press</a></li>								
								
						</ul>							
					</li>
					
				</ul>
			</nav>
		</div>
		<!-- Search -->
		<div class="3u">
			<div id="searchbar">
				<form method="get" action="/search" name="searchForm">
					<input type="text" value="" name="q" placeholder="elastic{search}" id="autocomplete">
					<button class="button icon" onclick="searchForm.submit()">GO</button>
				</form>
			</div>
			<div class="nav-auto-complete"></div>
		</div>
	</div>
</section>

		</div>
	</div>
</div>

<style>	
	
		.sc-downloads{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-docs{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-support{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-contact{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
		
</style>
		</div>
	</div>
  	<div id="content">
  		
  			
            <div id="pageheader">
    <div class="container">
        <header>
            <h1>Learn |</h1>
            <h2>Docs</h2>
        </header>
    </div>
</div>
<section id="guide">

            <!-- start body -->
<div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide</a></span> » <span class="breadcrumb-link"><a href="getting-started.html">Getting Started </a></span> » <span class="breadcrumb-link"><a href="distributed-docs.html">Distributed Document Store</a></span> » <span class="breadcrumb-node">Multidocument Patterns</span></div><div class="navheader"><span class="prev"><a href="_partial_updates_to_a_document.html">
              « 
              Partial Updates to a Document</a>
           
        </span><span class="next">
           
          <a href="search.html">Searching—The Basic Tools
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="distrib-multi-doc"></a>Multidocument Patterns<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/040_Distributed_CRUD/30_Bulk_requests.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="routing-value.html">Routing a Document to a Shard</a></span></dt><dt><span class="section"><a href="_how_primary_and_replica_shards_interact.html">How Primary and Replica Shards Interact</a></span></dt><dt><span class="section"><a href="distrib-write.html">Creating, Indexing, and Deleting a Document</a></span></dt><dt><span class="section"><a href="distrib-read.html">Retrieving a Document</a></span></dt><dt><span class="section"><a href="_partial_updates_to_a_document.html">Partial Updates to a Document</a></span></dt><dt><span class="section"><a href="distrib-multi-doc.html">Multidocument Patterns</a></span></dt></dl></div><p>The patterns for the <code class="literal">mget</code> and <code class="literal">bulk</code> APIs<a id="id-1.4.6.10.2.3" class="indexterm"></a>
<a id="id-1.4.6.10.2.4" class="indexterm"></a><a id="id-1.4.6.10.2.5" class="indexterm"></a>
<a id="id-1.4.6.10.2.6" class="indexterm"></a> are similar to those for
individual documents. The difference is that the requesting node knows in
which shard each document lives. It breaks up the multidocument request into
a multidocument request <span class="emphasis"><em>per shard</em></span>, and forwards these in parallel to each
participating node.</p><p>Once it receives answers from each node, it collates their responses
into a single response, which it returns to the client, as shown in <a class="xref" href="distrib-multi-doc.html#img-distrib-mget" title="Figure 12. Retrieving multiple documents with mget">Figure 12, “Retrieving multiple documents with <code class="literal">mget</code>”</a>.</p><div class="figure"><a id="img-distrib-mget"></a><p class="title"><strong>Figure 12. Retrieving multiple documents with <code class="literal">mget</code></strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/elas_0405.png" alt="Retrieving multiple documents with mget" /></div></div></div><br class="figure-break" /><p>Here is the sequence of steps necessary to retrieve multiple documents
with a single <code class="literal">mget</code> request:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The client sends an <code class="literal">mget</code> request to <code class="literal">Node 1</code>.
</li><li class="listitem">
<code class="literal">Node 1</code> builds a multi-get request per shard, and forwards these
   requests in parallel to the nodes hosting each required primary or replica
   shard. Once all replies have been received, <code class="literal">Node 1</code> builds the response
   and returns it to the client.
</li></ol></div><p>A <code class="literal">routing</code> parameter can <a id="id-1.4.6.10.7.2" class="indexterm"></a>be set for each document in the <code class="literal">docs</code> array.</p><p>The bulk API, as depicted in <a class="xref" href="distrib-multi-doc.html#img-distrib-bulk" title="Figure 13. Multiple document changes with bulk">Figure 13, “Multiple document changes with <code class="literal">bulk</code>”</a>, allows the execution of multiple create, index, delete, and update requests within a single bulk request.</p><div class="figure"><a id="img-distrib-bulk"></a><p class="title"><strong>Figure 13. Multiple document changes with <code class="literal">bulk</code></strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/elas_0406.png" alt="Multiple document changes with bulk" /></div></div></div><br class="figure-break" /><p>The sequence of steps<a id="id-1.4.6.10.10.1" class="indexterm"></a>
<a id="id-1.4.6.10.10.2" class="indexterm"></a><a id="id-1.4.6.10.10.3" class="indexterm"></a>
<a id="id-1.4.6.10.10.4" class="indexterm"></a> followed by the
<code class="literal">bulk</code> API are as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The client sends a <code class="literal">bulk</code> request to <code class="literal">Node 1</code>.
</li><li class="listitem">
<code class="literal">Node 1</code> builds a bulk request per shard, and forwards these requests in
    parallel to the nodes hosting each involved primary shard.
</li><li class="listitem">
The primary shard executes each action serially, one after another. As each
   action succeeds, the primary forwards the new document (or deletion) to its
   replica shards in parallel, and then moves on to the next action. Once all
   replica shards report success for all actions, the node reports success to
   the requesting node, which collates the responses and returns them to the
   client.
</li></ol></div><p>The <code class="literal">bulk</code> API also accepts<a id="id-1.4.6.10.12.2" class="indexterm"></a>
<a id="id-1.4.6.10.12.3" class="indexterm"></a><a id="id-1.4.6.10.12.4" class="indexterm"></a>
<a id="id-1.4.6.10.12.5" class="indexterm"></a> the <code class="literal">replication</code> and <code class="literal">consistency</code> parameters
at the top level for the whole <code class="literal">bulk</code> request, and the <code class="literal">routing</code> parameter
in the metadata for each request.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="bulk-format"></a>Why the Funny Format?<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/040_Distributed_CRUD/35_Bulk_format.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>When we learned about bulk requests <a id="id-1.4.6.10.13.2.1" class="indexterm"></a>
<a id="id-1.4.6.10.13.2.2" class="indexterm"></a>earlier in <a class="xref" href="bulk.html" title="Cheaper in Bulk">Cheaper in Bulk</a>, you may have asked
yourself, “Why does the <code class="literal">bulk</code> API require the funny format with the newline
characters, instead of just sending the requests wrapped in a JSON array, like
the <code class="literal">mget</code> API?”</p><p>To answer this, we need to explain a little background: Each document referenced in a bulk request may belong to a different primary
shard, each of which may be allocated to any of the nodes in the cluster. This
means that <a id="id-1.4.6.10.13.3.1" class="indexterm"></a>every <span class="emphasis"><em>action</em></span> inside a <code class="literal">bulk</code> request needs to be forwarded to the
correct shard on the correct node.</p><p>If the individual requests were wrapped up in a JSON array, that would mean
that we would need to do the following:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Parse the JSON into an array (including the document data, which
   can be very large)
</li><li class="listitem">
Look at each request to determine which shard it should go to
</li><li class="listitem">
Create an array of requests for each shard
</li><li class="listitem">
Serialize these arrays into the internal transport format
</li><li class="listitem">
Send the requests to each shard
</li></ul></div><p>It would work, but would need a lot of RAM to hold copies of essentially
the same data, and would create many more data structures that the Java Virtual Machine (JVM) would have to spend time garbage collecting.</p><p>Instead, Elasticsearch reaches up into the networking buffer, where the raw
request has been received, and reads the data directly. It uses the newline
characters to identify and parse just the small <code class="literal">action/metadata</code> lines in
order to decide which shard should handle each request.</p><p>These raw requests are forwarded directly to the correct shard. There
is no redundant copying of data, no wasted data structures. The entire
request process is handled in the smallest amount of memory possible.</p></div></div><div class="navfooter"><span class="prev"><a href="_partial_updates_to_a_document.html">
              « 
              Partial Updates to a Document</a>
           
        </span><span class="next">
           
          <a href="search.html">Searching—The Basic Tools
               »
            </a></span></div>
<!-- end body -->

            </section>

            <!-- Footer -->
        
	<div id="footer-wrapper">
		<section id="footer" class="container">
			<div class="row">
				<div class="12u">
					<!-- Copyright -->
					<div id="copyright">
	<p>
		© 2015. All Rights Reserved - Elasticsearch
	</p>
	<ul class="links">
		<li>Elasticsearch is a trademark of Elasticsearch BV, registered in the U.S. and in other countries</li>
		<li><a href="/legal/trademarks" id="footer_trademarks">Trademarks</a></li>
		<li><a href="/legal/terms-of-use" id="footer_terms">Terms</a></li>
		<li><a href="/legal/privacy-policy" id="footer_privacy">Privacy</a></li>
	</ul>
	<p>
		Apache, Apache Lucene, Apache Hadoop, Hadoop, HDFS and the yellow elephant logo are trademarks of the <a href="http://www.apache.org/" target="_blank">Apache Software Foundation</a> in the United States and/or other&nbsp;countries.
	</p>
</div><!--<div class="row">
{replace4}
</div>-->
				</div>
			</div>					
		</section>
	</div>
			
	<!-- Social Media -->
	<div id="socialmedia-wrapper">
		<section id="socialmedia" class="container">
			<!-- social icons -->
			<div id="social">
				<ul class="links">
					
						<li class="facebook grayscale"><a href="http://www.facebook.com/elastic.co" target="_blank" id="footer_facebook"></a></li>
					
						<li class="twitter grayscale"><a href="https://www.twitter.com/elastic" target="_blank" id="footer_twitter"></a></li>
					
						<li class="linkedin grayscale"><a href="http://www.linkedin.com/company/elasticsearch" target="_blank" id="footer_linkedin"></a></li>
					
						<li class="xing grayscale"><a href="https://www.xing.com/companies/elastic.co" target="_blank" id="footer_xing"></a></li>
					
				</ul>
			</div>
		</section>
	</div>


<style type="text/css">
	
		.facebook{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.twitter{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.linkedin{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.xing{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
</style>	

  	</div>
  	<!-- <div class="preloader">
    	<div class="status"></div>
	</div> -->
  	<style></style>
   	<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/jquery.autocomplete.js"></script>
<script src="/static/js/script.js"></script>
   	
   	
   	
   	<script type="application/ld+json">
	{
	  	"@context": "http://schema.org",
	  	"@type": "Organization",
	  	"name" : "Elastic",
	  	"url": "https://www.elastic.co/",
	  	"logo": "https://www.elastic.co/static/img/logo-elastic.png",
		"sameAs" : [ "https://www.facebook.com/elastic.co",
			"https://twitter.com/elastic",
			"https://plus.google.com/105178019064686397293",
			"https://www.youtube.com/user/elasticsearch",
			"https://www.linkedin.com/company/elasticsearch"
		],
	  	"potentialAction": {
	    	"@type": "SearchAction",
	    	"target": "https://www.elastic.co/search?q={query_string}",
	    	"query-input": "required name=query_string"
	  	}
	}
</script>	

            <script type="text/javascript">
  jQuery(function() {
    jQuery('#guide a[id]').each(function() { this.href='#'+this.id });
    jQuery('pre.prettyprint').each(function() {
      var pre = jQuery(this);
      pre.css('position','absolute');
      pre.css('width','auto');
      var height = pre.innerHeight();
      pre.wrap('<div class="pre_wrapper" style="height:' + (10 + height) + 'px"></div>');
    })
  });
</script>
<script type='text/javascript' src='https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js'></script>
<script type="text/javascript" >
  (function ($, $a, $title, $list) {
    $a = $('[id^="js-api-method-index"]');
    if (!$a.size()) return;
    $('#guide').addClass('js-client-docs');
    $list = $a.siblings('.itemizedlist').detach();
    $title = $(document.createElement('h2')).text('api methods')
    $a.parent().remove();
    $('.toc').first().append($(document.createElement('div')).addClass('js-api-method-index').append($title).append($list));
  }(jQuery));
</script>

            </body>
        