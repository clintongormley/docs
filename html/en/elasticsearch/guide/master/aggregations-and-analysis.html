
<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Aggregations and Analysis</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide" /><link rel="up" href="controlling-memory.html" title="Controlling Memory Use and Latency" /><link rel="prev" href="fielddata.html" title="Fielddata" /><link rel="next" href="_limiting_memory_usage.html" title="Limiting Memory Usage" />
  
 
 	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
 	
	<meta name="description" content="" />
	<meta name="keywords" content="" />



	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<!-- For third-generation iPad with high-resolution Retina display: -->
	<link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">

	<!-- For iPhone with high-resolution Retina display: -->

	<link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">

	<!-- For first- and second-generation iPad: -->

	<link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">

	<link type="text/css" rel="stylesheet" href="/static/css/skel.css" />	
	<link type="text/css" rel="stylesheet" href="/static/css/style.css" />	
	<script src="/static/js/skel.min.js"></script>
	<script type="text/javascript">form_name = "common_layout"</script>
	<script src="/static/js/init.js"></script>
	<script src="/static/js/classie.js"></script>
	

	
	<link type="text/css" rel="stylesheet" href="/static/css/prettify.css" />	
	<script type="text/javascript" src="/static/js/prettify.js"></script>



<link rel="stylesheet" type="text/css" href="styles.css" />
<script type="text/javascript">
  jQuery(function() {
    jQuery('#guide a[id]').each(function() { this.href='#'+this.id });
    jQuery('pre.prettyprint').each(function() {
      var pre = jQuery(this);
      pre.css('position','absolute');
      pre.css('width','auto');
      var height = pre.innerHeight();
      pre.wrap('<div class="pre_wrapper" style="height:' + height + 'px"></div>');
    })
  });
</script>
<script type='text/javascript' src='https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js'></script>

</head>
<body >
	
	<div class="header-cont">
		<div id="header-wrapper">
			

<div class="container">
	<div class="row">
		<div class="12u">
			<section>
				<div class="row">
					<div class="8u 6u(small) 5u(xsmall)">
						<div id="elastic">
							<h1><a href="/"></a></h1>
						</div>
						<!-- Searchbar Input box -->
						<form method="get" action="/search" name="searchForm" class="header-search-form">
						   <input type="text" id="search-header" name="q" class="form-control global-input" placeholder="elastic{search}">
						</form>
					</div>
					<div class="4u 6u(small) 7u(xsmall)">
						<!-- Mobile Menu -->
						<div class="mobile-menu-wrapper">
							<ul class="m-shortcuts">
								<li><a id="header-search" class="m-search" href="#"></a></li>
								<li><a class="m-guide" href="/guide"></a></li>
							</ul>											
							<nav class="nav-menu">
								<div class="menu-button">
									<span></span>
								</div>
								<div class="nav-menu-list-wrap">
									<div class="nav-menu-list">
										<h3><a href="/products">Products</a></h3>
										<ul>
											<li><a href="/products/elasticsearch">Elasticsearch</a></li>
											<li><a href="/products/logstash">Logstash</a></li>
											<li><a href="/products/kibana">Kibana</a></li>
											<li><a href="/products/shield">Shield</a></li>
											<li><a href="/products/marvel">Marvel</a></li>
											<li><a href="/products/hadoop">Hadoop</a></li>
											<li><a href="/subscriptions">Support</a></li>
											<li><a href="/downloads">Downloads</a></li>
										</ul>
										<h3><a href="/subscriptions">Subscriptions</a></h3>
										<h3><a href="/learn">Learn</a></h3>
										<ul>
											<li><a href="/guide">Docs</a></li>
											<li><a href="/videos">Videos</a></li>
											<li><a href="http://purchases.elasticsearch.com" target="_blank">Training</a></li>
											<li><a href="/blog">Blog</a></li>
										</ul>
										<h3><a href="/community">Community</a></h3>
										<ul>
											<li><a href="/community/meetups">Meetups</a></li>
										</ul>
										<h3><a href="/use-cases">Use Cases</a></h3>
										<h3><a href="/about">About</a></h3>
										<ul>
											<li><a href="/about/leadership">Leadership</a></li>
											<li><a href="/about/board">Board of Directors</a></li>
											<li><a href="/about/careers">Careers</a></li>
											<li><a href="/about/partners">Partners</a></li>
											<li><a href="/about/press">Press</a></li>
										</ul>
									</div>
								</div>
							</nav>
						</div>
						<!-- Shortcuts -->
						<nav id="shortcuts">
							<ul class="links">
								
									<li class="sc-downloads grayscale"><a href="/downloads" id="header_downloads">downloads</a></li>
								
									<li class="sc-docs grayscale"><a href="/guide" id="header_guide">docs</a></li>
								
									<li class="sc-support grayscale"><a href="/subscriptions" id="header_subscriptions">support</a></li>
								
									<li class="sc-contact grayscale"><a href="/contact" id="header_contact">contact</a></li>
								
							</ul>
						</nav>
					</div>
				</div>
			</section>
			

<section class="desktop-main-nav">
	<div class="row">
		<div class="9u">
			<!-- Nav -->
			<nav id="nav">
				<ul>
					
					<li>
						<a href="/products" id="nav_products" >PRODUCTS</a>
						
						<ul class="dropdown">
							
								<li><a href="/products/elasticsearch" id="nav_elasticsearch" >elasticsearch</a></li>								
							
								<li><a href="/products/logstash" id="nav_logstash" >logstash</a></li>								
							
								<li><a href="/products/kibana" id="nav_kibana" >kibana</a></li>								
							
								<li><a href="/products/shield" id="nav_shield" >shield</a></li>								
							
								<li><a href="/products/marvel" id="nav_marvel" >marvel</a></li>								
							
								<li><a href="/products/hadoop" id="nav_hadoop" >hadoop</a></li>								
							
								<li><a href="/subscriptions" id="nav_support" >support</a></li>								
							
								<li><a href="/downloads" id="nav_downloads" >downloads</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/subscriptions" id="nav_subscriptions" >SUBSCRIPTIONS</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/learn" id="nav_learn" >LEARN</a>
						
						<ul class="dropdown">
							
								<li><a href="/guide" id="nav_guide" >docs</a></li>								
							
								<li><a href="/videos" id="nav_videos" >videos</a></li>								
							
								<li><a href="http://purchases.elastic.co" id="nav_training" >training</a></li>								
							
								<li><a href="/blog" id="nav_learn_blog" >blog</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/community" id="nav_community" >COMMUNITY</a>
						
						<ul class="dropdown">
							
								<li><a href="/community/meetups" id="nav_meetups" >meetups</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/use-cases" id="nav_usecases" >USE CASES</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/blog" id="nav_blog" >BLOG</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/about" id="nav_about" >ABOUT</a>
						
						<ul class="dropdown">
							
								<li><a href="/about/leadership" id="nav_leadership" >leadership</a></li>								
							
								<li><a href="/about/board" id="nav_board" >board of directors</a></li>								
							
								<li><a href="/about/careers" id="nav_careers" >careers</a></li>								
							
								<li><a href="/about/partners" id="nav_partners" >partners</a></li>								
							
								<li><a href="/about/press" id="nav_press" >press</a></li>								
								
						</ul>							
					</li>
					
				</ul>
			</nav>
		</div>
		<!-- Search -->
		<div class="3u">
			<div id="searchbar">
				<form method="get" action="/search" name="searchForm">
					<input type="text" value="" name="q" placeholder="elastic{search}">
					<button class="button icon" onclick="searchForm.submit()">GO</button>
				</form>
			</div>
		</div>
	</div>
</section>

		</div>
	</div>
</div>

<style>	
	
		.sc-downloads{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-docs{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-support{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-contact{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
		
</style>
		</div>
	</div>
  	<div id="content">
  		
  			
            <div id="pageheader">
    <div class="container">
        <header>
            <h1>Learn |</h1>
            <h2>Docs</h2>
        </header>
    </div>
</div>
<section id="guide">

            <!-- start body -->
<div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide</a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations </a></span> » <span class="breadcrumb-link"><a href="controlling-memory.html">Controlling Memory Use and Latency</a></span> » <span class="breadcrumb-node">Aggregations and Analysis</span></div><div class="navheader"><span class="prev"><a href="fielddata.html">
              « 
              Fielddata</a>
           
        </span><span class="next">
           
          <a href="_limiting_memory_usage.html">Limiting Memory Usage
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="aggregations-and-analysis"></a>Aggregations and Analysis<a href="https://github.com/elasticsearch/elasticsearch-definitive-guide/edit/master/300_Aggregations/95_analyzed_vs_not.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="fielddata.html">Fielddata</a></span></dt><dt><span class="section"><a href="aggregations-and-analysis.html">Aggregations and Analysis</a></span></dt><dt><span class="section"><a href="_limiting_memory_usage.html">Limiting Memory Usage</a></span></dt><dt><span class="section"><a href="_fielddata_filtering.html">Fielddata Filtering</a></span></dt><dt><span class="section"><a href="doc-values.html">Doc Values</a></span></dt><dt><span class="section"><a href="preload-fielddata.html">Preloading Fielddata</a></span></dt><dt><span class="section"><a href="_preventing_combinatorial_explosions.html">Preventing Combinatorial Explosions</a></span></dt></dl></div><p>Some aggregations, such as the <code class="literal">terms</code> bucket, operate<a id="id-1.7.12.3.2.2" class="indexterm"></a>
<a id="id-1.7.12.3.2.3" class="indexterm"></a><a id="id-1.7.12.3.2.4" class="indexterm"></a>
<a id="id-1.7.12.3.2.5" class="indexterm"></a> on string fields.  And
string fields may be either <code class="literal">analyzed</code> or <code class="literal">not_analyzed</code>, which begs the question:
how does analysis affect aggregations?<a id="id-1.7.12.3.2.8" class="indexterm"></a>
<a id="id-1.7.12.3.2.9" class="indexterm"></a><a id="id-1.7.12.3.2.10" class="indexterm"></a><a id="id-1.7.12.3.2.11" class="indexterm"></a></p><p>The answer is "a lot," but it is best shown through an example.  First, index
some documents representing various states in the US:</p><pre class="programlisting prettyprint lang-js">POST /agg_analysis/data/_bulk
{ "index": {}}
{ "state" : "New York" }
{ "index": {}}
{ "state" : "New Jersey" }
{ "index": {}}
{ "state" : "New Mexico" }
{ "index": {}}
{ "state" : "New York" }
{ "index": {}}
{ "state" : "New York" }</pre><p>We want to build a list of unique states in our dataset, complete with counts.
Simple—let’s use a <code class="literal">terms</code> bucket:</p><pre class="programlisting prettyprint lang-js">GET /agg_analysis/data/_search?search_type=count
{
    "aggs" : {
        "states" : {
            "terms" : {
                "field" : "state"
            }
        }
    }
}</pre><p>This gives us these results:</p><pre class="programlisting prettyprint lang-js">{
...
   "aggregations": {
      "states": {
         "buckets": [
            {
               "key": "new",
               "doc_count": 5
            },
            {
               "key": "york",
               "doc_count": 3
            },
            {
               "key": "jersey",
               "doc_count": 1
            },
            {
               "key": "mexico",
               "doc_count": 1
            }
         ]
      }
   }
}</pre><p>Oh dear, that’s not at all what we want!  Instead of counting states, the aggregation
is counting individual words.  The underlying reason is simple: aggregations
are built from the inverted index, and the inverted index is <span class="emphasis"><em>post-analysis</em></span>.</p><p>When we added those documents to Elasticsearch, the string <code class="literal">"New York"</code> was
analyzed/tokenized into <code class="literal">["new", "york"]</code>.  These individual tokens were then
used to populate fielddata, and ultimately we see counts for <code class="literal">new</code> instead of
<code class="literal">New York</code>.</p><p>This is obviously not the behavior that we wanted, but luckily it is easily
corrected.</p><p>We need to define a multifield for <code class="literal">state</code> and set it to <code class="literal">not_analyzed</code>.  This
will prevent <code class="literal">New York</code> from being analyzed, which means it will stay a single
token in the aggregation.  Let’s try the whole process over, but this time
specify a <span class="emphasis"><em>raw</em></span> multifield:</p><pre class="programlisting prettyprint lang-js">DELETE /agg_analysis/
PUT /agg_analysis
{
  "mappings": {
    "data": {
      "properties": {
        "state" : {
          "type": "string",
          "fields": {
            "raw" : {
              "type": "string",
              "index": "not_analyzed"<a id="CO217-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
            }
          }
        }
      }
    }
  }
}

POST /agg_analysis/data/_bulk
{ "index": {}}
{ "state" : "New York" }
{ "index": {}}
{ "state" : "New Jersey" }
{ "index": {}}
{ "state" : "New Mexico" }
{ "index": {}}
{ "state" : "New York" }
{ "index": {}}
{ "state" : "New York" }

GET /agg_analysis/data/_search?search_type=count
{
  "aggs" : {
    "states" : {
        "terms" : {
            "field" : "state.raw" <a id="CO217-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
        }
    }
  }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO217-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
This time we explicitly map the <code class="literal">state</code> field and include a <code class="literal">not_analyzed</code> sub-field.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO217-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The aggregation is run on <code class="literal">state.raw</code> instead of <code class="literal">state</code>.
</p></td></tr></table></div><p>Now when we run our aggregation, we get results that make sense:</p><pre class="programlisting prettyprint lang-js">{
...
   "aggregations": {
      "states": {
         "buckets": [
            {
               "key": "New York",
               "doc_count": 3
            },
            {
               "key": "New Jersey",
               "doc_count": 1
            },
            {
               "key": "New Mexico",
               "doc_count": 1
            }
         ]
      }
   }
}</pre><p>In practice, this kind of problem is easy to spot.  Your aggregations
will simply return strange buckets, and you’ll remember the analysis issue.
It is a generalization, but there are not many instances where you want to use
an analyzed  field in an aggregation.  When in doubt, add a multifield so
you have the option for both.<a id="id-1.7.12.3.17.1" class="indexterm"></a>
<a id="id-1.7.12.3.17.2" class="indexterm"></a></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_high_cardinality_memory_implications"></a>High-Cardinality Memory Implications<a href="https://github.com/elasticsearch/elasticsearch-definitive-guide/edit/master/300_Aggregations/95_analyzed_vs_not.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>There is another reason to avoid aggregating analyzed fields: high-cardinality
fields consume a large amount of memory when loaded into fielddata.<a id="id-1.7.12.3.18.2.1" class="indexterm"></a>
<a id="id-1.7.12.3.18.2.2" class="indexterm"></a><a id="id-1.7.12.3.18.2.3" class="indexterm"></a>
<a id="id-1.7.12.3.18.2.4" class="indexterm"></a>  The
analysis process often (although not always) generates a large number of tokens,
many of  which are unique.  This increases the overall cardinality of the field
and contributes to more memory pressure.<a id="id-1.7.12.3.18.2.5" class="indexterm"></a>
<a id="id-1.7.12.3.18.2.6" class="indexterm"></a></p><p>Some types of analysis are <span class="emphasis"><em>extremely</em></span> unfriendly with regards to memory.
Consider an n-gram analysis process.<a id="id-1.7.12.3.18.3.2" class="indexterm"></a>
<a id="id-1.7.12.3.18.3.3" class="indexterm"></a>  The term <code class="literal">New York</code> might be n-grammed into
the following tokens:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">ne</code>
</li><li class="listitem">
<code class="literal">ew</code>
</li><li class="listitem">
<code class="literal">w </code>
</li><li class="listitem">
<code class="literal"> y</code>
</li><li class="listitem">
<code class="literal">yo</code>
</li><li class="listitem">
<code class="literal">or</code>
</li><li class="listitem">
<code class="literal">rk</code>
</li></ul></div><p>You can imagine how the n-gramming process creates a huge number of unique tokens,
especially when analyzing paragraphs of text.  When these are loaded into memory,
you can easily exhaust your heap space.</p><p>So, before aggregating across fields, take a second to verify that the fields are
<code class="literal">not_analyzed</code>.  And if you want to aggregate analyzed fields, ensure that the analysis
process is not creating an obscene number of tokens.</p><div class="tip admon"><div class="icon"><img alt="Tip" src="images/icons/tip.png" /></div><div class="admon_content"><p>At the end of the day, it doesn’t matter whether a field is <code class="literal">analyzed</code> or
<code class="literal">not_analyzed</code>. The more unique values in a field—the higher the
cardinality of the field—the more memory that is required. This is
especially true for string fields, where every unique string must be held in
memory—longer strings use more memory.</p></div></div></div></div><div class="navfooter"><span class="prev"><a href="fielddata.html">
              « 
              Fielddata</a>
           
        </span><span class="next">
           
          <a href="_limiting_memory_usage.html">Limiting Memory Usage
               »
            </a></span></div>
<!-- end body -->

            </section>
<script type="text/javascript" >
  (function ($, $a, $title, $list) {
    $a = $('[id^="js-api-method-index"]');
    if (!$a.size()) return;
    $('#guide').addClass('js-client-docs');
    $list = $a.siblings('.itemizedlist').detach();
    $title = $(document.createElement('h2')).text('api methods')
    $a.parent().remove();
    $('.toc').first().append($(document.createElement('div')).addClass('js-api-method-index').append($title).append($list));
  }(jQuery));
</script>

            <!-- Footer -->
        
	<div id="footer-wrapper">
		<section id="footer" class="container">
			<div class="row">
				<div class="12u">
					<!-- Copyright -->
					<div id="copyright">
	<p>
		© 2015. All Rights Reserved - Elasticsearch
	</p>
	<ul class="links">
		<li>Elasticsearch is a trademark of Elasticsearch BV, registered in the U.S. and in other countries</li>
		<li><a href="/legal/trademarks" id="footer_trademarks">Trademarks</a></li>
		<li><a href="/legal/terms-of-use" id="footer_terms">Terms</a></li>
		<li><a href="/legal/privacy-policy" id="footer_privacy">Privacy</a></li>
	</ul>
	<p>
		Apache, Apache Lucene, Apache Hadoop, Hadoop, HDFS and the yellow elephant logo are trademarks of the <a href="http://www.apache.org/" target="_blank">Apache Software Foundation</a> in the United States and/or other&nbsp;countries.
	</p>
</div><!--<div class="row">
{replace4}
</div>-->
				</div>
			</div>					
		</section>
	</div>
			
	<!-- Social Media -->
	<div id="socialmedia-wrapper">
		<section id="socialmedia" class="container">
			<!-- social icons -->
			<div id="social">
				<ul class="links">
					
						<li class="facebook grayscale"><a href="http://www.facebook.com/elastic.co" target="_blank" id="footer_facebook"></a></li>
					
						<li class="twitter grayscale"><a href="https://www.twitter.com/elastic" target="_blank" id="footer_twitter"></a></li>
					
						<li class="linkedin grayscale"><a href="http://www.linkedin.com/company/elasticsearch" target="_blank" id="footer_linkedin"></a></li>
					
						<li class="xing grayscale"><a href="https://www.xing.com/companies/elasticsearch" target="_blank" id="footer_xing"></a></li>
					
				</ul>
			</div>
		</section>
	</div>


<style type="text/css">
	
		.facebook{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.twitter{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.linkedin{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.xing{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
</style>	

  	</div>
  	<!-- <div class="preloader">
    	<div class="status"></div>
	</div> -->
  	<style></style>
   	<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/script.js"></script>
   	
   		<!-- Google Tag Manager -->
	<script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5"
													  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
			'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-58RLH5');</script>
	<!-- End Google Tag Manager -->
</body>