
<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Shared Index</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide" /><link rel="up" href="scale.html" title="Designing for Scale" /><link rel="prev" href="user-based.html" title="User-Based Data" /><link rel="next" href="faking-it.html" title="Faking Index per User with Aliases" />
  
 
 	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
 	
	<meta name="description" content="" />
	<meta name="keywords" content="" />



	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<link type="text/css" rel="stylesheet" href="/static/css/load.css" />
	<link type="text/css" rel="stylesheet" href="/static/css/skel.css" />		
	
	<script src="/static/js/jquery.min.js"></script>
	<script src="/static/js/loading.js"></script>
	<script src="/static/js/skel.min.js"></script>
	<script src="/static/js/skel-layers.min.js"></script>
	<script src="/static/js/classie.js"></script>	
	<script type="text/javascript">form_name = "common_layout"</script>
	<script src="/static/js/init.js"></script>
	
	<link type="text/css" rel="stylesheet" href="/static/css/prettify.css" />	
	<script type="text/javascript" src="/static/js/prettify.js"></script>



<link rel="stylesheet" type="text/css" href="styles.css" />
<script type="text/javascript">
  jQuery(function() {
    jQuery('#guide a[id]').each(function() { this.href='#'+this.id });
    jQuery('pre.prettyprint').each(function() {
      var pre = jQuery(this);
      pre.css('position','absolute');
      pre.css('width','auto');
      var height = pre.innerHeight();
      pre.wrap('<div class="pre_wrapper" style="height:' + height + 'px"></div>');
    })
  });
</script>
<script type='text/javascript' src='https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js'></script>

</head>
<body >

	<div class="preloader">
    	<div class="status"></div>
	</div>
	<!-- Google Tag Manager -->
	<script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5"
													  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
			'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-58RLH5');</script>
	<!-- End Google Tag Manager -->
	
	<div class="header-cont">
		<div id="header-wrapper">
			

<div class="container">
	<div class="row">
		<div class="12u">
			<section>
				<div class="row">
					<div class="8u 6u(small) 5u(xsmall)">
						<div id="elastic">
							<h1><a href="/"></a></h1>
						</div>
						<!-- Searchbar Input box -->
						<form method="get" action="/search" name="searchForm" class="header-search-form">
						   <input type="text" id="search-header" name="q" class="form-control global-input" placeholder="elastic{search}">
						</form>
					</div>
					<div class="4u 6u(small) 7u(xsmall)">
						<!-- Mobile Menu -->
						<div class="mobile-menu-wrapper">
							<ul class="m-shortcuts">
								<li><a id="header-search" class="m-search" href="#"></a></li>
								<li><a class="m-guide" href="/guide"></a></li>
							</ul>											
							<nav class="nav-menu">
								<div class="menu-button">
									<span></span>
								</div>
								<div class="nav-menu-list-wrap">
									<div class="nav-menu-list">
										<h3><a href="/products">Products</a></h3>
										<ul>
											<li><a href="/products/elasticsearch">Elasticsearch</a></li>
											<li><a href="/products/logstash">Logstash</a></li>
											<li><a href="/products/kibana">Kibana</a></li>
											<li><a href="/products/shield">Shield</a></li>
											<li><a href="/products/marvel">Marvel</a></li>
											<li><a href="/products/hadoop">Hadoop</a></li>
											<li><a href="/subscriptions">Support</a></li>
											<li><a href="/downloads">Downloads</a></li>
										</ul>
										<h3><a href="/subscriptions">Subscriptions</a></h3>
										<h3><a href="/learn">Learn</a></h3>
										<ul>
											<li><a href="/guide">Docs</a></li>
											<li><a href="/videos">Videos</a></li>
											<li><a href="http://purchases.elasticsearch.com" target="_blank">Training</a></li>
											<li><a href="/blog">Blog</a></li>
										</ul>
										<h3><a href="/community">Community</a></h3>
										<ul>
											<li><a href="/community/meetups">Meetups</a></li>
										</ul>
										<h3><a href="/use-cases">Use Cases</a></h3>
										<h3><a href="/about">About</a></h3>
										<ul>
											<li><a href="/about/leadership">Leadership</a></li>
											<li><a href="/about/board">Board of Directors</a></li>
											<li><a href="/about/careers">Careers</a></li>
											<li><a href="/about/partners">Partners</a></li>
											<li><a href="/about/press">Press</a></li>
										</ul>
									</div>
								</div>
							</nav>
						</div>
						<!-- Shortcuts -->
						<nav id="shortcuts">
							<ul class="links">
								
									<li class="sc-downloads grayscale"><a href="/downloads" id="header_downloads">downloads</a></li>
								
									<li class="sc-docs grayscale"><a href="/guide" id="header_guide">docs</a></li>
								
									<li class="sc-support grayscale"><a href="/subscriptions" id="header_subscriptions">support</a></li>
								
									<li class="sc-contact grayscale"><a href="/contact" id="header_contact">contact</a></li>
								
							</ul>
						</nav>
					</div>
				</div>
			</section>
			

<section class="desktop-main-nav">
	<div class="row">
		<div class="9u">
			<!-- Nav -->
			<nav id="nav">
				<ul>
					
					<li>
						<a href="/products" id="nav_products" >PRODUCTS</a>
						
						<ul class="dropdown">
							
								<li><a href="/products/elasticsearch" id="nav_elasticsearch" >elasticsearch</a></li>								
							
								<li><a href="/products/logstash" id="nav_logstash" >logstash</a></li>								
							
								<li><a href="/products/kibana" id="nav_kibana" >kibana</a></li>								
							
								<li><a href="/products/shield" id="nav_shield" >shield</a></li>								
							
								<li><a href="/products/marvel" id="nav_marvel" >marvel</a></li>								
							
								<li><a href="/products/hadoop" id="nav_hadoop" >hadoop</a></li>								
							
								<li><a href="/subscriptions" id="nav_support" >support</a></li>								
							
								<li><a href="/downloads" id="nav_downloads" >downloads</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/subscriptions" id="nav_subscriptions" >SUBSCRIPTIONS</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/learn" id="nav_learn" >LEARN</a>
						
						<ul class="dropdown">
							
								<li><a href="/guide" id="nav_guide" >docs</a></li>								
							
								<li><a href="/videos" id="nav_videos" >videos</a></li>								
							
								<li><a href="http://purchases.elastic.co" id="nav_training" >training</a></li>								
							
								<li><a href="/blog" id="nav_learn_blog" >blog</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/community" id="nav_community" >COMMUNITY</a>
						
						<ul class="dropdown">
							
								<li><a href="/community/meetups" id="nav_meetups" >meetups</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/use-cases" id="nav_usecases" >USE CASES</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/blog" id="nav_blog" >BLOG</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/about" id="nav_about" >ABOUT</a>
						
						<ul class="dropdown">
							
								<li><a href="/about/leadership" id="nav_leadership" >leadership</a></li>								
							
								<li><a href="/about/board" id="nav_board" >board of directors</a></li>								
							
								<li><a href="/about/careers" id="nav_careers" >careers</a></li>								
							
								<li><a href="/about/partners" id="nav_partners" >partners</a></li>								
							
								<li><a href="/about/press" id="nav_press" >press</a></li>								
								
						</ul>							
					</li>
					
				</ul>
			</nav>
		</div>
		<!-- Search -->
		<div class="3u">
			<div id="searchbar">
				<form method="get" action="/search" name="searchForm">
					<input type="text" value="" name="q" placeholder="elastic{search}">
					<button class="button icon" onclick="searchForm.submit()">GO</button>
				</form>
			</div>
		</div>
	</div>
</section>

		</div>
	</div>
</div>

<style>	
	
		.sc-downloads{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-docs{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-support{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-contact{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
		
</style>
		</div>
	</div>
  	<div id="content">
  		
  			
            <div id="pageheader">
    <div class="container">
        <header>
            <h1>Learn |</h1>
            <h2>Docs</h2>
        </header>
    </div>
</div>
<section id="guide">

            <!-- start body -->
<div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide</a></span> » <span class="breadcrumb-link"><a href="modeling-your-data.html">Modeling Your Data </a></span> » <span class="breadcrumb-link"><a href="scale.html">Designing for Scale</a></span> » <span class="breadcrumb-node">Shared Index</span></div><div class="navheader"><span class="prev"><a href="user-based.html">
              « 
              User-Based Data</a>
           
        </span><span class="next">
           
          <a href="faking-it.html">Faking Index per User with Aliases
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="shared-index"></a>Shared Index<a href="https://github.com/elasticsearch/elasticsearch-definitive-guide/edit/master/410_Scaling/65_Shared_index.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="shard-scale.html">The Unit of Scale</a></span></dt><dt><span class="section"><a href="overallocation.html">Shard Overallocation</a></span></dt><dt><span class="section"><a href="kagillion-shards.html">Kagillion Shards</a></span></dt><dt><span class="section"><a href="capacity-planning.html">Capacity Planning</a></span></dt><dt><span class="section"><a href="replica-shards.html">Replica Shards</a></span></dt><dt><span class="section"><a href="multiple-indices.html">Multiple Indices</a></span></dt><dt><span class="section"><a href="time-based.html">Time-Based Data</a></span></dt><dt><span class="section"><a href="index-templates.html">Index Templates</a></span></dt><dt><span class="section"><a href="retiring-data.html">Retiring Data</a></span></dt><dt><span class="section"><a href="user-based.html">User-Based Data</a></span></dt><dt><span class="section"><a href="shared-index.html">Shared Index</a></span></dt><dt><span class="section"><a href="faking-it.html">Faking Index per User with Aliases</a></span></dt><dt><span class="section"><a href="one-big-user.html">One Big User</a></span></dt><dt><span class="section"><a href="finite-scale.html">Scale Is Not Infinite</a></span></dt></dl></div><p>We can use a large shared index for the many smaller <a id="id-1.9.6.17.2.1" class="indexterm"></a>
<a id="id-1.9.6.17.2.2" class="indexterm"></a><a id="id-1.9.6.17.2.3" class="indexterm"></a>
<a id="id-1.9.6.17.2.4" class="indexterm"></a>forums by indexing
the forum identifier in a field and using it as a filter:</p><pre class="programlisting prettyprint lang-json">PUT /forums
{
  "settings": {
    "number_of_shards": 10 <a id="CO300-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
  },
  "mappings": {
    "post": {
      "properties": {
        "forum_id": { <a id="CO300-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
          "type":  "string",
          "index": "not_analyzed"
        }
      }
    }
  }
}

PUT /forums/post/1
{
  "forum_id": "baking", <a id="CO300-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
  "title":    "Easy recipe for ginger nuts",
  ...
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO300-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Create an index large enough to hold thousands of smaller forums.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO300-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> <a href="#CO300-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Each post must include a <code class="literal">forum_id</code> to identify which forum it belongs
    to.
</p></td></tr></table></div><p>We can use the <code class="literal">forum_id</code> as a filter to search within a single forum.  The
filter will exclude most of the documents in the index (those from other
forums), and filter caching will ensure that responses are fast:</p><pre class="programlisting prettyprint lang-json">GET /forums/post/_search
{
  "query": {
    "filtered": {
      "query": {
        "match": {
          "title": "ginger nuts"
        }
      },
      "filter": {
        "term": { <a id="CO301-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
          "forum_id": {
            "baking"
          }
        }
      }
    }
  }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO301-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">term</code> filter is cached by default.
</p></td></tr></table></div><p>This approach works, but we can do better. <a id="id-1.9.6.17.8.1" class="indexterm"></a>
<a id="id-1.9.6.17.8.2" class="indexterm"></a> The posts from a single forum
would fit easily onto one shard, but currently they are scattered across all ten
shards in the index. This means that every search request has to be forwarded
to a primary or replica of all ten shards. What would be ideal is to ensure
that all the posts from a single forum are stored on the same shard.</p><p>In <a class="xref" href="routing-value.html" title="Routing a Document to a Shard">Routing a Document to a Shard</a>, we explained<a id="id-1.9.6.17.9.2" class="indexterm"></a> that a document is allocated to a
particular shard by using this formula:</p><pre class="literallayout">shard = hash(routing) % number_of_primary_shards</pre><p>The <code class="literal">routing</code> value defaults to the document’s <code class="literal">_id</code>, but we can override that
and provide our own custom routing value, such as <code class="literal">forum_id</code>.  All
documents with the same <code class="literal">routing</code> value will be stored on the same shard:</p><pre class="programlisting prettyprint lang-json">PUT /forums/post/1?routing=baking <a id="CO302-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
{
  "forum_id": "baking", <a id="CO302-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
  "title":    "Easy recipe for ginger nuts",
  ...
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO302-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> <a href="#CO302-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Using <code class="literal">forum_id</code> as the routing value ensures that all posts from the
    same forum are stored on the same shard.
</p></td></tr></table></div><p>When we search for posts in a particular forum, we can pass the same <code class="literal">routing</code>
value to ensure that the search request is run on only the single shard that
holds our documents:</p><pre class="programlisting prettyprint lang-json">GET /forums/post/_search?routing=baking <a id="CO303-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
{
  "query": {
    "filtered": {
      "query": {
        "match": {
          "title": "ginger nuts"
        }
      },
      "filter": {
        "term": { <a id="CO303-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
          "forum_id": {
            "baking"
          }
        }
      }
    }
  }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO303-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The query is run on only the shard that corresponds to this <code class="literal">routing</code> value.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO303-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
We still need the filter, as a single shard can hold posts from many forums.
</p></td></tr></table></div><p>Multiple forums can be queried by passing a comma-separated list of <code class="literal">routing</code>
values, and including each <code class="literal">forum_id</code> in a <code class="literal">terms</code> filter:</p><pre class="programlisting prettyprint lang-json">GET /forums/post/_search?routing=baking,cooking,recipes
{
  "query": {
    "filtered": {
      "query": {
        "match": {
          "title": "ginger nuts"
        }
      },
      "filter": {
        "terms": {
          "forum_id": {
            [ "baking", "cooking", "recipes" ]
          }
        }
      }
    }
  }
}</pre><p>While this approach is technically efficient, it looks a bit clumsy because of
the need to specify <code class="literal">routing</code> values and <code class="literal">terms</code> filters on every query or
indexing request.  Index aliases to the rescue!</p></div><div class="navfooter"><span class="prev"><a href="user-based.html">
              « 
              User-Based Data</a>
           
        </span><span class="next">
           
          <a href="faking-it.html">Faking Index per User with Aliases
               »
            </a></span></div>
<!-- end body -->

            </section>
<script type="text/javascript" >
  (function ($, $a, $title, $list) {
    $a = $('[id^="js-api-method-index"]');
    if (!$a.size()) return;
    $('#guide').addClass('js-client-docs');
    $list = $a.siblings('.itemizedlist').detach();
    $title = $(document.createElement('h2')).text('api methods')
    $a.parent().remove();
    $('.toc').first().append($(document.createElement('div')).addClass('js-api-method-index').append($title).append($list));
  }(jQuery));
</script>

            <!-- Footer -->
        
	<div id="footer-wrapper">
		<section id="footer" class="container">
			<div class="row">
				<div class="12u">
					<!-- Copyright -->
					<div id="copyright">
	<p>
		© 2015. All Rights Reserved - Elasticsearch
	</p>
	<ul class="links">
		<li>Elasticsearch is a trademark of Elasticsearch BV, registered in the U.S. and in other countries</li>
		<li><a href="/legal/trademarks" id="footer_trademarks">Trademarks</a></li>
		<li><a href="/legal/terms-of-use" id="footer_terms">Terms</a></li>
		<li><a href="/legal/privacy-policy" id="footer_privacy">Privacy</a></li>
	</ul>
	<p>
		Apache, Apache Lucene, Apache Hadoop, Hadoop, HDFS and the yellow elephant logo are trademarks of the <a href="http://www.apache.org/" target="_blank">Apache Software Foundation</a> in the United States and/or other&nbsp;countries.
	</p>
</div><!--<div class="row">
{replace4}
</div>-->
				</div>
			</div>					
		</section>
	</div>
			
	<!-- Social Media -->
	<div id="socialmedia-wrapper">
		<section id="socialmedia" class="container">
			<!-- social icons -->
			<div id="social">
				<ul class="links">
					
						<li class="facebook grayscale"><a href="http://www.facebook.com/elastic.co" target="_blank" id="footer_facebook"></a></li>
					
						<li class="twitter grayscale"><a href="https://www.twitter.com/elastic" target="_blank" id="footer_twitter"></a></li>
					
						<li class="linkedin grayscale"><a href="http://www.linkedin.com/company/elasticsearch" target="_blank" id="footer_linkedin"></a></li>
					
						<li class="xing grayscale"><a href="https://www.xing.com/companies/elasticsearch" target="_blank" id="footer_xing"></a></li>
					
				</ul>
			</div>
		</section>
	</div>


<style type="text/css">
	
		.facebook{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.twitter{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.linkedin{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.xing{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
</style>	

  	</div>
  	<div class="preloader">
    	<div class="status"></div>
	</div>
  	<style></style>
   	<link type="text/css" rel="stylesheet" href="/static/css/flexslider.css" >

<script src="/static/js/jquery.flexslider.min.js"></script>
<script src="/static/js/jquery.dropdown.min.js"></script>
<script src="/static/js/script.js"></script>
   	
</body>