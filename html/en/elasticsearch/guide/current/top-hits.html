
<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Field Collapsing</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide" /><link rel="up" href="relations.html" title="Handling Relationships" /><link rel="prev" href="denormalization.html" title="Denormalizing Your Data" /><link rel="next" href="denormalization-concurrency.html" title="Denormalization and Concurrency" />
  
 
 	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
 	
	<meta name="description" content="" />
	<meta name="keywords" content="" />



	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<link type="text/css" rel="stylesheet" href="/static/css/skel.css" />		
	
	<script src="/static/js/jquery.min.js"></script>
	<script src="/static/js/loading.js"></script>
	<script src="/static/js/skel.min.js"></script>
	<script src="/static/js/skel-layers.min.js"></script>
	<script src="/static/js/classie.js"></script>	
	<script type="text/javascript">form_name = "common_layout"</script>
	<script src="/static/js/init.js"></script>
	
	<link type="text/css" rel="stylesheet" href="/static/css/prettify.css" />	
	<script type="text/javascript" src="/static/js/prettify.js"></script>



<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
<link rel="stylesheet" type="text/css" href="styles.css" />
<script type="text/javascript">
  jQuery(function() {
    jQuery('#guide a[id]').each(function() { this.href='#'+this.id });
    jQuery('pre.prettyprint').each(function() {
      var pre = jQuery(this);
      pre.css('position','absolute');
      pre.css('width','auto');
      var height = pre.innerHeight();
      pre.wrap('<div class="pre_wrapper" style="height:' + height + 'px"></div>');
    })
  });
</script>
<script type='text/javascript' src='https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js'></script>

</head>
<body >
	<!-- Google Tag Manager -->
	<script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5"
													  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
			'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-58RLH5');</script>
	<!-- End Google Tag Manager -->
	
	<div class="header-cont">
		<div id="header-wrapper">
			

<div class="container">
	<div class="row">
		<div class="12u">
			<section>
				<div class="row">
					<div class="8u 6u(small) 5u(xsmall)">
						<div id="elastic">
							<h1><a href="/"></a></h1>
						</div>
						<!-- Searchbar Input box -->
						<div class="header-search-form">
						   <input type="text" id="search-header" name="q" class="form-control global-input" placeholder="{elastic} search">
						</div>
					</div>
					<div class="4u 6u(small) 7u(xsmall)">
						<!-- Mobile Menu -->
						<div class="mobile-menu-wrapper">
							<ul class="m-shortcuts">
								<li><a id="header-search" class="m-search" href="#"></a></li>
								<li><a class="m-guide" href="#"></a></li>
							</ul>											
							<nav class="nav-menu">
								<div class="menu-button">
									<span></span>
								</div>
								<div class="nav-menu-list-wrap">
									<div class="nav-menu-list">
										<h3><a href="#">Products</a></h3>
										<ul>
											<li><a href="#">elasticsearch</a></li>
											<li><a href="#">logstash</a></li>
											<li><a href="#">kibana</a></li>
											<li><a href="#">shield</a></li>
											<li><a href="#">marvel</a></li>
											<li><a href="#">hadoop</a></li>
											<li><a href="#">support</a></li>
											<li><a href="#">downloads</a></li>
										</ul>
										<h3><a href="#">SUBSCRIPTIONS</a></h3>
										<h3><a href="#">LEARN</a></h3>
										<ul>
											<li><a href="#">guide</a></li>
											<li><a href="#">videos</a></li>
											<li><a href="#">training</a></li>
											<li><a href="#">blog</a></li>
										</ul>
									</div>
								</div>
							</nav>
						</div>
						<!-- Shortcuts -->
						<nav id="shortcuts">
							<ul class="links">
								
									<li class="sc-downloads grayscale"><a href="/downloads" id="header_downloads">downloads</a></li>
								
									<li class="sc-guide grayscale"><a href="/guide" id="header_guide">guide</a></li>
								
									<li class="sc-support grayscale"><a href="/subscriptions" id="header_subscriptions">support</a></li>
								
									<li class="sc-contact grayscale"><a href="/contact" id="header_contact">contact</a></li>
								
							</ul>
						</nav>
					</div>
				</div>
			</section>
			

<section class="desktop-main-nav">
	<div class="row">
		<div class="9u">
			<!-- Nav -->
			<nav id="nav">
				<ul>
					
					<li>
						<a href="/products" id="nav_products" >PRODUCTS</a>
						
						<ul class="dropdown">
							
								<li><a href="/products/elasticsearch" id="nav_elasticsearch" >elasticsearch</a></li>								
							
								<li><a href="/products/logstash" id="nav_logstash" >logstash</a></li>								
							
								<li><a href="/products/kibana" id="nav_kibana" >kibana</a></li>								
							
								<li><a href="/products/shield" id="nav_shield" >shield</a></li>								
							
								<li><a href="/products/marvel" id="nav_marvel" >marvel</a></li>								
							
								<li><a href="/products/hadoop" id="nav_hadoop" >hadoop</a></li>								
							
								<li><a href="/subscriptions" id="nav_support" >support</a></li>								
							
								<li><a href="/downloads" id="nav_downloads" >downloads</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/subscriptions" id="nav_subscriptions" >SUBSCRIPTIONS</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/learn" id="nav_learn" >LEARN</a>
						
						<ul class="dropdown">
							
								<li><a href="/guide" id="nav_guide" >guide</a></li>								
							
								<li><a href="/videos" id="nav_videos" >videos</a></li>								
							
								<li><a href="http://purchases.elasticsearch.com" id="nav_training" >training</a></li>								
							
								<li><a href="/blog" id="nav_learn_blog" >blog</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/community" id="nav_community" >COMMUNITY</a>
						
						<ul class="dropdown">
							
								<li><a href="/community/meetups" id="nav_meetups" >meetups</a></li>								
								
						</ul>							
					</li>
					
					<li>
						<a href="/use-cases" id="nav_usecases" >USE CASES</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/blog" id="nav_blog" >BLOG</a>
						
						<ul class="dropdown">
								
						</ul>							
					</li>
					
					<li>
						<a href="/about" id="nav_about" >ABOUT</a>
						
						<ul class="dropdown">
							
								<li><a href="/about/leadership" id="nav_leadership" >leadership</a></li>								
							
								<li><a href="/about/board" id="nav_board" >board of directors</a></li>								
							
								<li><a href="/about/careers" id="nav_careers" >careers</a></li>								
							
								<li><a href="/about/partners" id="nav_partners" >partners</a></li>								
							
								<li><a href="/about/press" id="nav_press" >press</a></li>								
								
						</ul>							
					</li>
					
				</ul>
			</nav>
		</div>
		<!-- Search -->
		<div class="3u">
			<div id="searchbar">
				<form method="get" action="/search" name="searchForm">
					<input type="text" value="" name="q" placeholder="{elastic} search">
					<a class="button icon" onclick="searchForm.submit()">GO</a>
				</form>
			</div>
		</div>
	</div>
</section>

		</div>
	</div>
</div>

<style>	
	
		.sc-downloads{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-guide{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-support{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
	
		.sc-contact{ background: url("/assets/blt0b75d0822b89593e/shortcuts.png") no-repeat;}
		
</style>
		</div>
	</div>
  	<div id="content">
  		
            <div id="pageheader">
    <div class="container">
        <header>
            <h1>Learn |</h1>
            <h2>Docs</h2>
        </header>
    </div>
</div>
<section id="guide">

            <!-- start body -->
<div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide</a></span> » <span class="breadcrumb-link"><a href="modeling-your-data.html">Modeling Your Data </a></span> » <span class="breadcrumb-link"><a href="relations.html">Handling Relationships</a></span> » <span class="breadcrumb-node">Field Collapsing</span></div><div class="navheader"><span class="prev"><a href="denormalization.html">
              « 
              Denormalizing Your Data</a>
           
        </span><span class="next">
           
          <a href="denormalization-concurrency.html">Denormalization and Concurrency
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="top-hits"></a>Field Collapsing<a href="https://github.com/elasticsearch/elasticsearch-definitive-guide/edit/master/400_Relationships/22_Top_hits.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="application-joins.html">Application-side Joins</a></span></dt><dt><span class="section"><a href="denormalization.html">Denormalizing Your Data</a></span></dt><dt><span class="section"><a href="top-hits.html">Field Collapsing</a></span></dt><dt><span class="section"><a href="denormalization-concurrency.html">Denormalization and Concurrency</a></span></dt><dt><span class="section"><a href="concurrency-solutions.html">Solving Concurrency Issues</a></span></dt></dl></div><p>A common requirement is the need to present search results grouped by a particular
field. <a id="id-1.8.3.15.2.1" class="indexterm"></a><a id="id-1.8.3.15.2.2" class="indexterm"></a>
<a id="id-1.8.3.15.2.3" class="indexterm"></a>We might want to return the most relevant blog posts <span class="emphasis"><em>grouped</em></span> by the
user’s name. <a id="id-1.8.3.15.2.5" class="indexterm"></a><a id="id-1.8.3.15.2.6" class="indexterm"></a>
<a id="id-1.8.3.15.2.7" class="indexterm"></a> Grouping by name implies the need for a <code class="literal">terms</code> aggregation.  To
be able to group on the user’s <span class="emphasis"><em>whole</em></span> name, the name field should be
available in its original <code class="literal">not_analyzed</code> form, as explained in
<a class="xref" href="aggregations-and-analysis.html" title="Aggregations and Analysis">Aggregations and Analysis</a>:</p><pre class="programlisting prettyprint lang-json">PUT /my_index/_mapping/blogpost
{
  "properties": {
    "user": {
      "properties": {
        "name": { <a id="CO256-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
          "type": "string",
          "fields": {
            "raw": { <a id="CO256-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
              "type":  "string",
              "index": "not_analyzed"
            }
          }
        }
      }
    }
  }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO256-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">user.name</code> field will be used for full-text search.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO256-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">user.name.raw</code> field will be used for grouping with the <code class="literal">terms</code>
    aggregation.
</p></td></tr></table></div><p>Then add some data:</p><pre class="programlisting prettyprint lang-json">PUT /my_index/user/1
{
  "name": "John Smith",
  "email": "john@smith.com",
  "dob": "1970/10/24"
}

PUT /my_index/blogpost/2
{
  "title": "Relationships",
  "body": "It's complicated...",
  "user": {
    "id": 1,
    "name": "John Smith"
  }
}

PUT /my_index/user/3
{
  "name": "Alice John",
  "email": "alice@john.com",
  "dob": "1979/01/04"
}

PUT /my_index/blogpost/4
{
  "title": "Relationships are cool",
  "body": "It's not complicated at all...",
  "user": {
    "id": 3,
    "name": "Alice John"
  }
}</pre><p>Now we can run a query looking for blog posts about <code class="literal">relationships</code>, by users
called <code class="literal">John</code>, and group the results by user, thanks to the
<a class="ulink" href="http://bit.ly/1CrlWFQ" target="_top"><code class="literal">top_hits</code> aggregation</a>:</p><pre class="programlisting prettyprint lang-json">GET /my_index/blogpost/_search?search_type=count <a id="CO257-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
{
  "query": { <a id="CO257-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
    "bool": {
      "must": [
        { "match": { "title":     "relationships" }},
        { "match": { "user.name": "John"          }}
      ]
    }
  },
  "aggs": {
    "users": {
      "terms": {
        "field":   "user.name.raw",      <a id="CO257-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
        "order": { "top_score": "desc" } <a id="CO257-4"></a><span><img src="images/icons/callouts/4.png" alt="" /></span>
      },
      "aggs": {
        "top_score": { "max":      { "script":  "_score"           }}, <a id="CO257-5"></a><span><img src="images/icons/callouts/5.png" alt="" /></span>
        "blogposts": { "top_hits": { "_source": "title", "size": 5 }}  <a id="CO257-6"></a><span><img src="images/icons/callouts/6.png" alt="" /></span>
      }
    }
  }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO257-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The blog posts that we are interested in are returned under the
    <code class="literal">blogposts</code> aggregation, so we can disable the usual search <code class="literal">hits</code> by
    setting the <code class="literal">search_type=count</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO257-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">query</code> returns blog posts about <code class="literal">relationships</code> by users named <code class="literal">John</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO257-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">terms</code> aggregation creates a bucket for each <code class="literal">user.name.raw</code> value.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO257-4"><span><img src="images/icons/callouts/4.png" alt="" /></span></a> <a href="#CO257-5"><span><img src="images/icons/callouts/5.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">top_score</code> aggregation orders the terms in the <code class="literal">users</code> aggregation
    by the top-scoring document in each bucket.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO257-6"><span><img src="images/icons/callouts/6.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">top_hits</code> aggregation returns just the <code class="literal">title</code> field of the five most
    relevant blog posts for each user.
</p></td></tr></table></div><p>The abbreviated response is shown here:</p><pre class="programlisting prettyprint lang-json">...
"hits": {
  "total":     2,
  "max_score": 0,
  "hits":      [] <a id="CO258-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
},
"aggregations": {
  "users": {
     "buckets": [
        {
           "key":       "John Smith", <a id="CO258-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
           "doc_count": 1,
           "blogposts": {
              "hits": { <a id="CO258-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span>
                 "total":     1,
                 "max_score": 0.35258877,
                 "hits": [
                    {
                       "_index": "my_index",
                       "_type":  "blogpost",
                       "_id":    "2",
                       "_score": 0.35258877,
                       "_source": {
                          "title": "Relationships"
                       }
                    }
                 ]
              }
           },
           "top_score": { <a id="CO258-4"></a><span><img src="images/icons/callouts/4.png" alt="" /></span>
              "value": 0.3525887727737427
           }
        },
...</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO258-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">hits</code> array is empty because we set <code class="literal">search_type=count</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO258-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
There is a bucket for each user who appeared in the top results.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO258-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Under each user bucket there is a <code class="literal">blogposts.hits</code> array containing
    the top results for that user.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO258-4"><span><img src="images/icons/callouts/4.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The user buckets are sorted by the user’s most relevant blog post.
</p></td></tr></table></div><p>Using the <code class="literal">top_hits</code> aggregation is the<a id="id-1.8.3.15.13.2" class="indexterm"></a> equivalent of running a query to
return the names of the users with the most relevant blog posts, and then running
the same query for each user, to get their best blog posts. But it is much more
efficient.</p><p>The top hits returned in each bucket are the result of running a light
<span class="emphasis"><em>mini-query</em></span> based on the original main query.  The mini-query supports the
usual features that you would expect from search such as highlighting and
pagination.</p></div><div class="navfooter"><span class="prev"><a href="denormalization.html">
              « 
              Denormalizing Your Data</a>
           
        </span><span class="next">
           
          <a href="denormalization-concurrency.html">Denormalization and Concurrency
               »
            </a></span></div>
<!-- end body -->

            </section>
<script type="text/javascript" >
  (function ($, $a, $title, $list) {
    $a = $('[id^="js-api-method-index"]');
    if (!$a.size()) return;
    $('#guide').addClass('js-client-docs');
    $list = $a.siblings('.itemizedlist').detach();
    $title = $(document.createElement('h2')).text('api methods')
    $a.parent().remove();
    $('.toc').first().append($(document.createElement('div')).addClass('js-api-method-index').append($title).append($list));
  }(jQuery));
</script>

            <!-- Footer -->
        
	<div id="footer-wrapper">
		<section id="footer" class="container">
			<div class="row">
				<div class="12u">
					<!-- Copyright -->
					<div id="copyright">
						<p>&copy; 2015. All Rights Reserved - Elasticsearch</p>
						<ul class="links">
							<li>Elasticsearch is a trademark of Elasticsearch BV, registered in the U.S. and in other countries</li>
							
							<li><a href="/legal/trademarks" id="footer_trademarks">Trademarks</a></li>
							
							<li><a href="/legal/terms-of-use" id="footer_terms">Terms</a></li>
							
							<li><a href="/legal/privacy-policy" id="footer_privacy">Privacy</a></li>
							
						</ul>
					</div>
				</div>
			</div>					
		</section>
	</div>
			
	<!-- Social Media -->
	<div id="socialmedia-wrapper">
		<section id="socialmedia" class="container">
			<!-- social icons -->
			<div id="social">
				<ul class="links">
					
						<li class="facebook grayscale"><a href="http://www.facebook.com/elastic.co" target="_blank" id="footer_facebook"></a></li>
					
						<li class="twitter grayscale"><a href="https://www.twitter.com/elastic" target="_blank" id="footer_twitter"></a></li>
					
						<li class="linkedin grayscale"><a href="http://www.linkedin.com/company/elastic.co" target="_blank" id="footer_linkedin"></a></li>
					
						<li class="xing grayscale"><a href="https://www.xing.com/companies/elasticsearch" target="_blank" id="footer_xing"></a></li>
					
				</ul>
			</div>
		</section>
	</div>


<style type="text/css">
	
		.facebook{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.twitter{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.linkedin{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
		.xing{background:url("/assets/blte0d4d10ae3bd8337/social-media.png") no-repeat;}		
	
</style>	

  	</div>
  	<div class="preloader">
    	<div class="status"></div>
	</div>
  	<style></style>
   	<link type="text/css" rel="stylesheet" href="/static/css/flexslider.css" >

<script src="/static/js/jquery.flexslider.min.js"></script>
<script src="/static/js/jquery.dropdown.min.js"></script>
<script src="/static/js/script.js"></script>
   	
</body>